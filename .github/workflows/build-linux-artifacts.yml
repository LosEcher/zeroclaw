name: Build Linux Artifacts

on:
  workflow_dispatch:
    inputs:
      build_ref:
        description: "Git ref to build (branch/tag/SHA)"
        required: false
        default: "main"
        type: string
      profile:
        description: "Cargo profile"
        required: false
        default: "release"
        type: choice
        options:
          - release
          - release-fast
      features:
        description: 'Cargo features, comma-separated (example: "channel-lark,whatsapp-web")'
        required: false
        default: ""
        type: string
      include_aarch64:
        description: "Also build aarch64-unknown-linux-gnu"
        required: false
        default: true
        type: boolean

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  build-linux:
    name: Build ${{ matrix.target }}
    runs-on: blacksmith-2vcpu-ubuntu-2404
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            artifact: zeroclaw
            cross_compiler: ""
            linker_env: ""
            linker: ""
          - target: aarch64-unknown-linux-gnu
            artifact: zeroclaw
            cross_compiler: gcc-aarch64-linux-gnu
            linker_env: CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER
            linker: aarch64-linux-gnu-gcc
    steps:
      - name: Checkout repository
        if: matrix.target != 'aarch64-unknown-linux-gnu' || inputs.include_aarch64 == true
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          ref: ${{ inputs.build_ref }}

      - name: Setup Rust toolchain
        if: matrix.target != 'aarch64-unknown-linux-gnu' || inputs.include_aarch64 == true
        uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7 # stable
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      - name: Restore Rust cache
        if: matrix.target != 'aarch64-unknown-linux-gnu' || inputs.include_aarch64 == true
        uses: useblacksmith/rust-cache@f53e7f127245d2a269b3d90879ccf259876842d5 # v3

      - name: Install cross compiler
        if: (matrix.target != 'aarch64-unknown-linux-gnu' || inputs.include_aarch64 == true) && matrix.cross_compiler != ''
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y ${{ matrix.cross_compiler }}

      - name: Build
        if: matrix.target != 'aarch64-unknown-linux-gnu' || inputs.include_aarch64 == true
        shell: bash
        run: |
          set -euo pipefail

          features="${{ inputs.features }}"
          profile="${{ inputs.profile }}"
          cmd=(cargo build --locked --target "${{ matrix.target }}")

          if [[ "$profile" == "release" ]]; then
            cmd+=(--release)
            profile_dir="release"
          else
            cmd+=(--profile release-fast)
            profile_dir="release-fast"
          fi

          if [[ -n "$features" ]]; then
            cmd+=(--features "$features")
          fi

          if [[ -n "${{ matrix.linker_env }}" ]]; then
            export "${{ matrix.linker_env }}=${{ matrix.linker }}"
          fi

          echo "Running: ${cmd[*]}"
          "${cmd[@]}"

          mkdir -p dist
          cp "target/${{ matrix.target }}/${profile_dir}/${{ matrix.artifact }}" "dist/${{ matrix.artifact }}"
          tar -C dist -czf "zeroclaw-${{ matrix.target }}.tar.gz" "${{ matrix.artifact }}"

      - name: Upload artifact
        if: matrix.target != 'aarch64-unknown-linux-gnu' || inputs.include_aarch64 == true
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: zeroclaw-${{ matrix.target }}
          path: zeroclaw-${{ matrix.target }}.tar.gz
          if-no-files-found: error
